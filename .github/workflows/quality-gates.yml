name: quality-gates

on:
  pull_request:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      strict_p0:
        description: "Require P0=0 (release readiness mode)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

env:
  CONTENT_P0_BASELINE: "63"

jobs:
  content-audit:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Run curriculum integrity validator (report mode)
        run: |
          python3 plan_michael_phelps/scripts/validate_curriculum_integrity.py \
            --repo-root plan_michael_phelps \
            --json-out "$RUNNER_TEMP/curriculum_integrity.json"

      - name: Run canonical english sprint audit (baseline source)
        run: |
          python3 plan_michael_phelps/scripts/audit_english_sprint.py \
            --repo-root plan_michael_phelps \
            | tee "$RUNNER_TEMP/official_audit.txt"

      - name: Enforce P0 gate policy
        env:
          EVENT_NAME: ${{ github.event_name }}
          STRICT_P0_INPUT: ${{ github.event.inputs.strict_p0 }}
        run: |
          python3 - <<'PY'
          import json
          import os
          import re
          import sys
          from pathlib import Path

          baseline = int(os.environ.get("CONTENT_P0_BASELINE", "63"))
          event_name = os.environ.get("EVENT_NAME", "")
          strict_input = (os.environ.get("STRICT_P0_INPUT") or "").strip().lower()
          strict_mode = event_name == "workflow_dispatch" and strict_input == "true"

          audit_path = Path(os.environ["RUNNER_TEMP"]) / "official_audit.txt"
          text = audit_path.read_text(encoding="utf-8", errors="ignore")

          match = re.search(r"P0=(\d+)", text)
          if not match:
            print("ERROR: Unable to parse P0 from official audit output.", file=sys.stderr)
            sys.exit(2)

          p0 = int(match.group(1))
          limit = 0 if strict_mode else baseline
          mode = "STRICT_RELEASE" if strict_mode else f"BASELINE_NO_REGRESSION<= {baseline}"

          summary = {
            "mode": mode,
            "p0_current": p0,
            "p0_limit": limit,
            "pass": p0 <= limit,
          }

          out_path = Path(os.environ["RUNNER_TEMP"]) / "quality_gate_summary.json"
          out_path.write_text(json.dumps(summary, indent=2) + "\n", encoding="utf-8")

          print(f"Quality gate mode: {mode}")
          print(f"P0 current: {p0}")
          print(f"P0 limit: {limit}")

          if p0 > limit:
            print("Quality gate failed: P0 exceeds allowed threshold.", file=sys.stderr)
            sys.exit(1)

          print("Quality gate passed.")
          PY

      - name: Upload integrity reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-gates-report
          path: |
            ${{ runner.temp }}/curriculum_integrity.json
            ${{ runner.temp }}/official_audit.txt
            ${{ runner.temp }}/quality_gate_summary.json
          if-no-files-found: error

  architecture-docs:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Lint architecture docs
        run: |
          python3 plan_michael_phelps/scripts/lint_architecture_docs.py \
            --repo-root plan_michael_phelps

      - name: Check architecture docs drift
        run: |
          python3 plan_michael_phelps/scripts/check_docs_drift.py \
            --repo-root plan_michael_phelps \
            --json-out "$RUNNER_TEMP/docs_drift_report.json"

      - name: Upload architecture reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: architecture-docs-report
          path: |
            ${{ runner.temp }}/docs_drift_report.json
          if-no-files-found: error

  frontend-ux:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install ripgrep
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: Run frontend UX gates
        run: |
          bash plan_michael_phelps/scripts/run_frontend_ux_gates.sh plan_michael_phelps

  agent-quality-guardian:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs:
      - content-audit
      - architecture-docs
      - frontend-ux
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install ripgrep
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: Run agent quality guardian
        run: |
          python3 plan_michael_phelps/scripts/agent_quality_guardian.py \
            --repo-root plan_michael_phelps \
            --json-out "$RUNNER_TEMP/agent_quality_guardian.json"

      - name: Diagnose frontend-ux failure context
        if: ${{ needs.frontend-ux.result != 'success' }}
        run: |
          set +e
          bash plan_michael_phelps/scripts/run_frontend_ux_gates.sh plan_michael_phelps | tee "$RUNNER_TEMP/frontend_ux_diagnosis.log"
          echo "diagnosis_exit_code=$?" > "$RUNNER_TEMP/frontend_ux_diagnosis_meta.txt"
          exit 0

      - name: Upload guardian reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-quality-guardian-report
          path: |
            ${{ runner.temp }}/agent_quality_guardian.json
            ${{ runner.temp }}/frontend_ux_diagnosis.log
            ${{ runner.temp }}/frontend_ux_diagnosis_meta.txt
          if-no-files-found: ignore

      - name: Fail when frontend-ux failed upstream
        if: ${{ needs.frontend-ux.result != 'success' }}
        run: |
          echo "frontend-ux failed upstream. See 'agent-quality-guardian-report' artifact for diagnosis."
          exit 1
